# Case3Solver 详细计算公式报告

## 1. 基础参数定义

给定参数：
- 矩形尺寸：m (宽度), n (高度)
- 三个顶点参数：t = [t₀, t₁, t₂] (距离中心点的距离)
- 三个角度参数：θ = [θ₀, θ₁, θ₂] (相对于中心点的角度偏移)
- 容差参数：tol (数值计算容差)

## 2. 核心方程推导

### 2.1 通用位置方程
对于任意顶点i，其在矩形坐标系中的位置为：
```
x_i = xO + t_i * cos(φ + θ_i)
y_i = yO + t_i * sin(φ + θ_i)
```
其中φ是待求的旋转角度，(xO, yO)是中心点坐标。

### 2.2 边约束方程

#### 2.2.1 左边约束 (x=0)
```
xO + t_i * cos(φ + θ_i) = 0 ⇒ xO = -t_i * cos(φ + θ_i)
```

#### 2.2.2 右边约束 (x=m)
```
xO + t_i * cos(φ + θ_i) = m ⇒ xO = m - t_i * cos(φ + θ_i)
```

#### 2.2.3 上边约束 (y=n)
```
yO + t_i * sin(φ + θ_i) = n ⇒ yO = n - t_i * sin(φ + θ_i)
```

#### 2.2.4 下边约束 (y=0)
```
yO + t_i * sin(φ + θ_i) = 0 ⇒ yO = -t_i * sin(φ + θ_i)
```

## 3. 分类求解公式

### 3.1 情况1：左右边组合 + 上/下边 (left, right, top/bottom)

#### 3.1.1 方程建立
设：
- P0在左边：xO = -t₀ * cos(φ + θ₀)
- P1在右边：xO = m - t₁ * cos(φ + θ₁)

联立得：
```
-t₀ * cos(φ + θ₀) = m - t₁ * cos(φ + θ₁)
⇒ t₁ * cos(φ + θ₁) - t₀ * cos(φ + θ₀) = m
```

使用余弦差公式展开：
```
cos(φ + θᵢ) = cosφ * cosθᵢ - sinφ * sinθᵢ
```

整理为标准形式：
```
A * cosφ + B * sinφ = C
```
其中：
```
A = t₁ * cosθ₁ - t₀ * cosθ₀
B = t₁ * sinθ₁ - t₀ * sinθ₀
C = m
```

#### 3.1.2 方程求解
1. 计算范数：
   ```
   norm = √(A² + B²)
   ```
2. 检查可解性：
   ```
   |C| ≤ norm + tol
   ```
3. 计算辅助角：
   ```
   α = atan2(A, B)  # 注意参数顺序
   ```
4. 基本解：
   ```
   φ₁ = asin(C/norm) - α
   φ₂ = π - asin(C/norm) - α
   ```
5. 角度归一化：
   ```
   if φ < -π: φ += 2π
   if φ > π: φ -= 2π
   ```

### 3.2 情况2：左/右边 + 上边 + 下边 (left/right, top, bottom)

#### 3.2.1 方程建立
设：
- P0在左/右边
- P1在上边：yO = n - t₁ * sin(φ + θ₁)
- P2在下边：yO = -t₂ * sin(φ + θ₂)

联立得：
```
n - t₁ * sin(φ + θ₁) = -t₂ * sin(φ + θ₂)
⇒ t₂ * sin(φ + θ₂) - t₁ * sin(φ + θ₁) = n
```

使用正弦差公式展开：
```
sin(φ + θᵢ) = sinφ * cosθᵢ + cosφ * sinθᵢ
```

整理为标准形式：
```
A * cosφ + B * sinφ = C
```
其中：
```
A = t₂ * sinθ₂ - t₁ * sinθ₁
B = t₂ * cosθ₂ - t₁ * cosθ₁
C = n
```

#### 3.2.2 方程求解
(同3.1.2节)

## 4. 中心点坐标计算

### 4.1 单边约束计算
根据顶点所在边直接计算：
- 左边约束：xO = -tᵢ * cos(φ + θᵢ)
- 右边约束：xO = m - tᵢ * cos(φ + θᵢ)
- 上边约束：yO = n - tᵢ * sin(φ + θᵢ)
- 下边约束：yO = -tᵢ * sin(φ + θᵢ)

### 4.2 多约束平均
当有多个约束可用于同一坐标时，取平均值：
```
xO = (xO₁ + xO₂) / 2
yO = (yO₁ + yO₂) / 2
```

### 4.3 无约束处理
当某坐标无约束时，默认设为0：
```
xO = 0 (若无x约束)
yO = 0 (若无y约束)
```

## 5. 验证公式

### 5.1 边约束验证
对于每个顶点i，检查其计算位置是否在指定边上：
```
if 左边: |x_i| ≤ tol
if 右边: |x_i - m| ≤ tol
if 上边: |y_i - n| ≤ tol
if 下边: |y_i| ≤ tol
```

### 5.2 边界约束验证
检查顶点是否在矩形范围内：
```
0 - tol ≤ x_i ≤ m + tol
0 - tol ≤ y_i ≤ n + tol
```

### 5.3 自由边验证
确保顶点不在未分配的边上：
```
对于自由边e：
    if e是左边: |x_i| > tol
    if e是右边: |x_i - m| > tol
    if e是上边: |y_i - n| > tol
    if e是下边: |y_i| > tol
```

## 6. 完整计算流程示例

以(left, right, top)组合为例：

1. 建立方程：
   ```
   A = t₁*cosθ₁ - t₀*cosθ₀
   B = t₁*sinθ₁ - t₀*sinθ₀
   C = m
   ```

2. 解φ方程：
   ```
   norm = √(A² + B²)
   α = atan2(A, B)
   φ₁ = asin(m/norm) - α
   φ₂ = π - asin(m/norm) - α
   ```

3. 计算xO：
   ```
   xO_left = -t₀ * cos(φ + θ₀)
   xO_right = m - t₁ * cos(φ + θ₁)
   xO = (xO_left + xO_right)/2
   ```

4. 计算yO：
   ```
   yO_top = n - t₂ * sin(φ + θ₂)
   yO = yO_top  # 只有上边约束
   ```

5. 验证：
   ```
   检查P0是否在左边：|xO + t₀*cos(φ + θ₀)| ≤ tol
   检查P1是否在右边：|xO + t₁*cos(φ + θ₁) - m| ≤ tol
   检查P2是否在上边：|yO + t₂*sin(φ + θ₂) - n| ≤ tol
   检查所有点是否在矩形内
   检查无点在下边
   ```

## 7. 特殊情况处理

1. **无解情况**：
   - 当|C| > norm + tol时，直接跳过

2. **数值不稳定**：
   - 当norm接近0时，检查是否参数错误

3. **多解处理**：
   - 保留所有在[-π, π]范围内的解

4. **边界情况**：
   - 当点在角上时(如同时接近左边和上边)，需确保只属于指定边

## 8. 数学公式总结表

| 步骤 | 公式 | 说明 |
|------|------|------|
| 通用位置 | x_i = xO + t_i*cos(φ+θ_i)<br>y_i = yO + t_i*sin(φ+θ_i) | 顶点位置方程 |
| 左边约束 | xO = -t_i*cos(φ+θ_i) |  |
| 右边约束 | xO = m - t_i*cos(φ+θ_i) |  |
| 上边约束 | yO = n - t_i*sin(φ+θ_i) |  |
| 下边约束 | yO = -t_i*sin(φ+θ_i) |  |
| 标准方程 | A*cosφ + B*sinφ = C | 通用解法 |
| 左右组合系数 | A = t₁*cosθ₁ - t₀*cosθ₀<br>B = t₁*sinθ₁ - t₀*sinθ₀<br>C = m |  |
| 上下组合系数 | A = t₂*sinθ₂ - t₁*sinθ₁<br>B = t₂*cosθ₂ - t₁*cosθ₁<br>C = n |  |
| 方程求解 | norm = √(A²+B²)<br>α = atan2(A,B)<br>φ₁ = asin(C/norm)-α<br>φ₂ = π-asin(C/norm)-α |  |
| 角度归一化 | φ = φ mod 2π → [-π,π] |  |
| 坐标平均 | xO = (∑xO_i)/n | 多约束时 |
| 边验证 | 根据边类型检查x_i或y_i |  |
| 范围验证 | 0≤x_i≤m, 0≤y_i≤n |  |